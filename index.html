<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teepee Darts Cup - Mökkiturnaus</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg-dark: #032b24;
            --accent-yellow: #e7e359;
            --accent-green: #35a853;
            --card-bg: rgba(4, 42, 34, 0.9);
        }

        body {
            font-family: 'Oswald', sans-serif;
            background: radial-gradient(circle at top, #0f624f 0%, var(--bg-dark) 50%, #02140f 100%);
            color: #f8fafc;
            min-height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .brand-logo {
            width: 190px;
            max-width: 100%;
            filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.45));
        }

        .logo-frame {
            border: 1px solid rgba(231, 227, 89, 0.35);
            background: linear-gradient(180deg, rgba(53, 168, 83, 0.12) 0%, rgba(0, 0, 0, 0) 100%);
        }

        .match-card {
            transition: all 0.2s ease;
            backdrop-filter: blur(8px);
            background-color: var(--card-bg);
            border: 1px solid rgba(231, 227, 89, 0.12);
        }

        .dart-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 12px;
            height: 52px;
            min-height: 44px;
            user-select: none;
            transition: all 0.1s;
        }

        .dart-btn:active {
            background: var(--accent-yellow);
            color: black;
            transform: scale(0.95);
        }

        .multiplier-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .multiplier-btn.active {
            background: var(--accent-yellow);
            color: black;
            border-color: white;
        }

        .dart-slot {
            width: clamp(72px, 24vw, 100px);
            height: clamp(86px, 28vw, 120px);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(255, 255, 255, 0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: 'Roboto Mono', monospace;
        }

        .dart-slot.active {
            border-color: var(--accent-yellow);
            background: rgba(234, 179, 8, 0.15);
        }

        .bracket-container {
            display: flex;
            gap: 2rem;
            padding: 1rem;
            overflow-x: auto;
            min-height: 450px;
            align-items: center;
        }

        .bracket-round {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            gap: 2rem;
            min-width: 240px;
        }

        .player-header-name {
            max-width: 38vw;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
            vertical-align: bottom;
        }

        .bracket-connector {
            position: relative;
        }

        .bracket-connector::after {
            content: '→';
            position: absolute;
            right: -1.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-yellow);
            font-weight: bold;
            opacity: 0.5;
        }

        .bracket-champion-card {
            min-width: 240px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.9rem;
            padding: 1.1rem;
            text-align: center;
        }

        .bracket-champion-prize {
            width: min(32vw, 160px);
            max-height: 220px;
            object-fit: contain;
            filter: drop-shadow(0 14px 22px rgba(0, 0, 0, 0.45));
        }

        .bust-overlay {
            animation: fadeInOut 1s forwards;
        }

        .starter-coin {
            width: min(56vw, 280px);
            height: min(56vw, 280px);
            border-radius: 9999px;
            border: 3px solid rgba(254, 240, 138, 0.9);
            background: radial-gradient(circle at 35% 28%, #fef08a 0%, #facc15 30%, #f59e0b 70%, #b45309 100%);
            box-shadow: 0 0 0 4px rgba(217, 119, 6, 0.35), 0 22px 42px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.2rem;
            animation: starterCoinDrop 2.5s ease-out forwards;
        }

        .starter-coin-name {
            color: #ffffff;
            text-shadow: 0 6px 16px rgba(0, 0, 0, 0.45);
            letter-spacing: 0.05em;
            font-weight: 900;
            text-transform: uppercase;
            text-align: center;
            line-height: 1.1;
            font-size: clamp(1.4rem, 4.2vw, 2.6rem);
            animation: starterCoinNameSettle 2.5s ease-out forwards;
        }

        .winner-name-banner {
            position: relative;
            z-index: 3;
            animation: winnerRise 0.8s ease-out forwards;
            text-shadow: 0 10px 30px rgba(0, 0, 0, 0.55);
        }

        .tournament-prize-glow {
            position: absolute;
            width: min(56vw, 220px);
            height: min(56vw, 220px);
            border-radius: 9999px;
            background: radial-gradient(circle, rgba(231, 227, 89, 0.32) 0%, rgba(231, 227, 89, 0.06) 52%, rgba(0, 0, 0, 0) 72%);
            top: 44%;
            left: 50%;
            transform: translate(-50%, 8px) scale(0.72);
            z-index: 1;
            pointer-events: none;
            animation: prizeRiseGlow 1.2s ease-out 0.18s forwards, prizeGlowPulse 2.2s ease-in-out 1.3s infinite;
        }

        .tournament-prize-image {
            position: absolute;
            width: min(48vw, 180px);
            max-height: 36vh;
            object-fit: contain;
            left: 50%;
            top: 44%;
            transform: translate(-50%, 26px) scale(0.68);
            opacity: 0;
            filter: drop-shadow(0 18px 26px rgba(0, 0, 0, 0.52));
            z-index: 2;
            pointer-events: none;
            animation: prizeRise 1.15s ease-out 0.12s forwards;
        }

        @keyframes winnerRise {
            0% { opacity: 0; transform: translateY(20px) scale(0.8); }
            60% { opacity: 1; transform: translateY(-6px) scale(1.04); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes prizeRise {
            0% { opacity: 0; transform: translate(-50%, 26px) scale(0.68); }
            68% { opacity: 1; transform: translate(-50%, -292px) scale(1.01); }
            100% { opacity: 0.95; transform: translate(-50%, -326px) scale(1); }
        }

        @keyframes prizeRiseGlow {
            0% { opacity: 0; transform: translate(-50%, 8px) scale(0.72); }
            100% { opacity: 0.82; transform: translate(-50%, -286px) scale(1); }
        }

        @keyframes prizeGlowPulse {
            0%, 100% { opacity: 0.62; transform: translate(-50%, -286px) scale(1); }
            50% { opacity: 0.95; transform: translate(-50%, -286px) scale(1.08); }
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: scale(0.5); }
            20% { opacity: 1; transform: scale(1.1); }
            80% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(1.2); }
        }

        @keyframes starterCoinDrop {
            0% { opacity: 0; transform: translateY(-180px) rotateX(70deg) rotateZ(-1440deg) scale(0.65); }
            35% { opacity: 1; transform: translateY(16px) rotateX(0deg) rotateZ(-540deg) scale(1.06); }
            55% { transform: translateY(-10px) rotateZ(-220deg) scale(0.98); }
            72% { transform: translateY(6px) rotateZ(-80deg) scale(1.02); }
            100% { opacity: 1; transform: translateY(0) rotateZ(0deg) scale(1); }
        }

        @keyframes starterCoinNameSettle {
            0%, 58% { opacity: 0; transform: scale(0.55); }
            78% { opacity: 1; transform: scale(1.12); }
            100% { opacity: 1; transform: scale(1); }
        }

        @media (max-width: 768px) {
            .bracket-container {
                gap: 1rem;
                padding: 0.5rem;
            }

            .bracket-round,
            .bracket-champion-card {
                min-width: 210px;
            }

            .bracket-connector::after {
                right: -1rem;
            }
        }

        @media (max-width: 640px) {
            .dart-btn {
                border-radius: 10px;
                font-size: 1.05rem;
                height: 48px;
            }

            .dart-slot {
                border-radius: 14px;
                border-width: 1px;
            }

            .tournament-prize-image {
                width: min(62vw, 200px);
            }

            .tournament-prize-glow {
                width: min(68vw, 230px);
                height: min(68vw, 230px);
            }
        }
    </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    const STARTING_SCORE = 301;
    const LEGS_TO_WIN = 3;
    const VICTORY_MUSIC_SRC = 'assets/victory-music.mp3';
    const TOURNAMENT_PRIZE_SRC = 'assets/tournament-prize.png';
    const TOURNAMENT_CACHE_KEY = 'teepee-darts-cup-state-v1';
    const BOGEY_NUMBERS = new Set([169, 168, 166, 165, 163, 162, 159]);
    const FAVORITE_DOUBLES = [40, 32, 24, 16, 20, 36, 12, 8, 4, 2];
    const DEFAULT_PLAYERS = [
        'Pelaaja 1',
        'Pelaaja 2',
        'Pelaaja 3',
        'Pelaaja 4',
        'Pelaaja 5',
        'Pelaaja 6',
        'Pelaaja 7',
        'Pelaaja 8',
    ];
    const clampEvenPlayerCount = (value) => {
        const normalized = Number(value);
        if (Number.isNaN(normalized)) return 8;
        const clamped = Math.min(8, Math.max(2, normalized));
        return clamped % 2 === 0 ? clamped : clamped - 1;
    };

    const createPlayerNames = (count) => DEFAULT_PLAYERS.slice(0, count);
    const createBalancedGroups = (count) => {
        const midpoint = count / 2;
        return {
            groupA: Array.from({ length: midpoint }, (_, i) => i),
            groupB: Array.from({ length: midpoint }, (_, i) => i + midpoint),
        };
    };

    const createRoundRobinRounds = (group, label) => {
        if (!Array.isArray(group) || group.length < 2) return [];

        const hasOddPlayers = group.length % 2 !== 0;
        const bye = null;
        const rotation = hasOddPlayers ? [...group, bye] : [...group];
        const rounds = [];
        const roundCount = rotation.length - 1;
        const half = rotation.length / 2;

        for (let round = 0; round < roundCount; round++) {
            const matches = [];
            for (let i = 0; i < half; i++) {
                const p1 = rotation[i];
                const p2 = rotation[rotation.length - 1 - i];
                if (p1 !== bye && p2 !== bye) {
                    matches.push(createMatch({ group: label, p1, p2 }));
                }
            }
            rounds.push(matches);

            const fixed = rotation[0];
            const moving = rotation.slice(1);
            moving.unshift(moving.pop());
            rotation.splice(0, rotation.length, fixed, ...moving);
        }

        return rounds;
    };

    const createBalancedSchedule = (groupA, groupB) => {
        const roundsA = createRoundRobinRounds(groupA, 'A');
        const roundsB = createRoundRobinRounds(groupB, 'B');
        const totalRounds = Math.max(roundsA.length, roundsB.length);
        const orderedMatches = [];

        for (let round = 0; round < totalRounds; round++) {
            const openWithA = round % 2 === 0;
            const firstRound = openWithA ? roundsA[round] : roundsB[round];
            const secondRound = openWithA ? roundsB[round] : roundsA[round];

            if (firstRound) orderedMatches.push(...firstRound);
            if (secondRound) orderedMatches.push(...secondRound);
        }

        return orderedMatches.map((m, i) => ({
            ...m,
            id: `m-${i}`,
        }));
    };

    const scoreLabel = (value) => {
        if (value === 50) return 'BULL';
        if (value === 25) return '25';
        if (value <= 40 && value % 2 === 0) return `D${value / 2}`;
        if (value <= 60 && value % 3 === 0) return `T${value / 3}`;
        if (value <= 20) return `S${value}`;
        return String(value);
    };

    const setupThrowLabel = (value) => {
        if (value >= 1 && value <= 20) return `S${value}`;
        if (value === 25) return '25';
        if (value === 50) return 'BULL';
        if (value <= 60 && value % 3 === 0) return `T${value / 3}`;
        if (value <= 40 && value % 2 === 0) return `D${value / 2}`;
        return String(value);
    };

    const preferredDoubleLabel = (value) => {
        if (value === 50) return 'BULL';
        if (value > 1 && value <= 40 && value % 2 === 0) return `D${value / 2}`;
        return String(value);
    };

    const DOUBLE_FINISH_PRIORITY = [40, 32, 24, 16, 20, 36, 12, 8, 4, 2, 28, 26, 22, 18, 14, 10, 6, 30, 34, 38, 50];
    const DOUBLE_PRIORITY_INDEX = new Map(DOUBLE_FINISH_PRIORITY.map((value, index) => [value, index]));

    const TRIPLE_ORDER = [20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1];
    const DOUBLE_ORDER = [20, 16, 12, 10, 18, 14, 8, 6, 4, 2, 1, 3, 5, 7, 9, 11, 13, 15, 17, 19];
    const SINGLE_ORDER = [20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1];

    const FINISH_SEGMENTS = [
        ...TRIPLE_ORDER.map((n) => ({ kind: 'T', number: n, score: n * 3, label: `T${n}`, isDouble: false })),
        ...DOUBLE_ORDER.map((n) => ({ kind: 'D', number: n, score: n * 2, label: `D${n}`, isDouble: true })),
        ...SINGLE_ORDER.map((n) => ({ kind: 'S', number: n, score: n, label: `S${n}`, isDouble: false })),
        { kind: 'B', number: 50, score: 50, label: 'BULL', isDouble: true },
        { kind: 'B', number: 25, score: 25, label: '25', isDouble: false },
    ];

    const routeRank = (route, startScore) => {
        const last = route[route.length - 1];
        const doubleRank = DOUBLE_PRIORITY_INDEX.has(last.score) ? DOUBLE_PRIORITY_INDEX.get(last.score) : 99;
        const first = route[0];
        const middleDoubles = route.slice(0, -1).filter((s) => s.kind === 'D').length;
        const bullsBeforeFinish = route.slice(0, -1).filter((s) => s.kind === 'B').length;

        let rank = route.length * 100 + doubleRank * 3 + middleDoubles * 2 + bullsBeforeFinish * 2;

        if (startScore > 80 && route.length === 3 && first.kind !== 'T') rank += 18;
        if (startScore > 60 && route.length === 2 && first.kind === 'D') rank += 10;
        if (startScore <= 60 && route.length >= 2 && first.kind === 'T') rank += 12;

        return rank;
    };

    const getCheckoutRoutes = (score, dartsLeft, maxRoutes = 4) => {
        const rawRoutes = [];

        const walk = (remaining, darts, path) => {
            if (remaining === 0 && path.length > 0) {
                const last = path[path.length - 1];
                if (last.isDouble) rawRoutes.push(path);
                return;
            }
            if (remaining <= 1 || darts === 0) return;

            for (const segment of FINISH_SEGMENTS) {
                if (segment.score > remaining) continue;
                walk(remaining - segment.score, darts - 1, [...path, segment]);
            }
        };

        walk(score, dartsLeft, []);

        const deduped = [];
        const seen = new Set();
        rawRoutes
            .sort((a, b) => routeRank(a, score) - routeRank(b, score))
            .forEach((route) => {
                const key = route.map((s) => s.label).join('-');
                if (!seen.has(key)) {
                    seen.add(key);
                    deduped.push(route);
                }
            });

        return deduped.slice(0, maxRoutes);
    };

    const getMissScenarios = (bestRoute, score) => {
        if (!bestRoute || !bestRoute.length) return [];
        const first = bestRoute[0];
        const scenarios = [];

        if (first.kind === 'T') {
            scenarios.push({ label: `Jos osut ${`S${first.number}`} (tripla jäi sinkuksi)`, hit: first.number });
        } else if (first.kind === 'D') {
            scenarios.push({ label: `Jos osut ${`S${first.number}`} (tupla jäi sinkuksi)`, hit: first.number });
        } else if (first.kind === 'B' && first.number === 50) {
            scenarios.push({ label: 'Jos osut 25', hit: 25 });
        }

        scenarios.push({ label: 'Jos osut ohi', hit: 0 });

        return scenarios.map((scenario) => {
            const afterHit = score - scenario.hit;
            const next = getCheckoutRoutes(afterHit, 2, 1)[0];

            return {
                label: scenario.label,
                route: next ? next.map((s) => s.label).join(' → ') : getSetupSuggestion(afterHit),
            };
        });
    };

    const getSetupSuggestion = (score) => {
        const options = [];

        for (const target of FAVORITE_DOUBLES) {
            const setup = score - target;
            if (setup > 0 && setup <= 60) {
                options.push({
                    throwLabel: setupThrowLabel(setup),
                    leaveLabel: preferredDoubleLabel(target),
                });
            }
        }

        if (options.length > 1) {
            return `Pelaa setup: ${options[0].throwLabel} jättää ${options[0].leaveLabel} tai ${options[1].throwLabel} jättää ${options[1].leaveLabel}.`;
        }

        if (options.length === 1) {
            return `Pelaa setup: ${options[0].throwLabel} jättää ${options[0].leaveLabel}.`;
        }

        return 'Pelaa korkea setup (T20/T19) ja vältä 1 tai bust.';
    };

    const getCheckoutAdvice = (score, dartsLeft) => {
        if (score < 2 || score > 170) {
            return { message: 'Checkout-suositukset näkyvät pisteille 2–170.', best: null, alternatives: [], missPlan: [], bogey: false };
        }

        if (BOGEY_NUMBERS.has(score)) {
            return {
                message: `Bogey-luku (${score}) – suoraa 3 tikan checkoutia ei ole.`,
                best: null,
                alternatives: [],
                missPlan: [],
                bogey: true,
                setup: getSetupSuggestion(score),
            };
        }

        const routes = getCheckoutRoutes(score, dartsLeft, 5);
        if (!routes.length) {
            return {
                message: 'Ei suoraa checkoutia tällä tikkojen määrällä. Pelaa setup seuraavalle vuorolle.',
                best: null,
                alternatives: [],
                missPlan: [],
                bogey: false,
                setup: getSetupSuggestion(score),
            };
        }

        const [best, ...alternatives] = routes;
        const missPlan = dartsLeft === 3 ? getMissScenarios(best, score) : [];

        return {
            message: 'Optimaalinen checkout ja vaihtoehdot alla.',
            best: best.map((s) => s.label).join(' → '),
            alternatives: alternatives.map((route) => route.map((s) => s.label).join(' → ')),
            missPlan,
            bogey: false,
        };
    };

    const canCheckoutInOneDart = (score) => score === 50 || (score > 1 && score <= 40 && score % 2 === 0);

    const getStandings = (players, matches, groupPlayersIndices, groupLabel) => {
        const groupMatches = matches.filter((m) => m.group === groupLabel);
        const standings = groupPlayersIndices.map((idx) => {
            const name = players[idx];
            let played = 0;
            let wins = 0;
            let legsWon = 0;
            let legsLost = 0;

            groupMatches.forEach((m) => {
                if (m.played && (m.p1 === idx || m.p2 === idx)) {
                    played++;
                    if (m.p1 === idx) {
                        legsWon += m.s1;
                        legsLost += m.s2;
                        if (m.s1 > m.s2) wins++;
                    } else {
                        legsWon += m.s2;
                        legsLost += m.s1;
                        if (m.s2 > m.s1) wins++;
                    }
                }
            });

            return { name, wins, played, legsDiff: legsWon - legsLost, idx };
        });

        return standings.sort((a, b) => b.wins - a.wins || b.legsDiff - a.legsDiff);
    };

    const createMatch = (base) => ({
        ...base,
        s1: 0,
        s2: 0,
        played: false,
        history: [],
    });

    function BrandLogo({ compact = false }) {
        const [logoFailed, setLogoFailed] = useState(false);

        if (logoFailed) {
            return (
                <div className={`uppercase font-black italic ${compact ? 'text-lg' : 'text-3xl'} tracking-tight`}>
                    Teepee <span className="text-yellow-300">Darts Cup</span>
                </div>
            );
        }

        return (
            <img
                src="assets/teepee-darts-cup-logo.png"
                alt="Teepee Darts Cup virallinen logo"
                className={`brand-logo ${compact ? 'w-28' : ''}`}
                onError={() => setLogoFailed(true)}
            />
        );
    }

    function App() {
        const defaultPlayerCount = 8;
        const initialGroups = createBalancedGroups(defaultPlayerCount);
        const [view, setView] = useState('setup');
        const [tab, setTab] = useState('schedule');
        const [playerCount, setPlayerCount] = useState(defaultPlayerCount);
        const [players, setPlayers] = useState(createPlayerNames(defaultPlayerCount));
        const [groupA, setGroupA] = useState(initialGroups.groupA);
        const [groupB, setGroupB] = useState(initialGroups.groupB);
        const [groupMatches, setGroupMatches] = useState([]);
        const [bracketMatches, setBracketMatches] = useState([]);
        const [activeMatch, setActiveMatch] = useState(null);

        const hasGroups = playerCount >= 6;

        useEffect(() => {
            if (!hasGroups && tab === 'groups') setTab('schedule');
        }, [hasGroups, tab]);

        const createInitialBracketMatches = (count, seededPlayers) => {
            if (count === 2) {
                return [createMatch({ id: 'f', round: 'F', p1: seededPlayers[0], p2: seededPlayers[1], winner: null, label: 'Finaali' })];
            }

            if (count === 4) {
                return [
                    createMatch({ id: 'sf1', round: 'SF', p1: seededPlayers[0], p2: seededPlayers[3], winner: null, label: 'Välierä 1' }),
                    createMatch({ id: 'sf2', round: 'SF', p1: seededPlayers[1], p2: seededPlayers[2], winner: null, label: 'Välierä 2' }),
                    createMatch({ id: 'f', round: 'F', p1: null, p2: null, winner: null, label: 'Finaali' }),
                ];
            }

            return [
                createMatch({ id: 'wc1', round: 'WC', p1: null, p2: null, winner: null, label: 'Wild Card 1' }),
                createMatch({ id: 'wc2', round: 'WC', p1: null, p2: null, winner: null, label: 'Wild Card 2' }),
                createMatch({ id: 'sf1', round: 'SF', p1: null, p2: null, winner: null, label: 'Välierä 1' }),
                createMatch({ id: 'sf2', round: 'SF', p1: null, p2: null, winner: null, label: 'Välierä 2' }),
                createMatch({ id: 'f', round: 'F', p1: null, p2: null, winner: null, label: 'Finaali' }),
            ];
        };

        useEffect(() => {
            try {
                const cached = localStorage.getItem(TOURNAMENT_CACHE_KEY);
                if (!cached) return;

                const parsed = JSON.parse(cached);
                if (!parsed || typeof parsed !== 'object') return;

                const cachedCount = clampEvenPlayerCount(parsed.playerCount ?? parsed.players?.length ?? defaultPlayerCount);
                const fallbackPlayers = createPlayerNames(cachedCount);
                const cachedPlayers = Array.isArray(parsed.players) ? parsed.players.slice(0, cachedCount) : fallbackPlayers;
                while (cachedPlayers.length < cachedCount) {
                    cachedPlayers.push(fallbackPlayers[cachedPlayers.length]);
                }
                const fallbackGroups = createBalancedGroups(cachedCount);

                if (parsed.view === 'setup' || parsed.view === 'tournament') setView(parsed.view);
                setPlayerCount(cachedCount);
                setPlayers(cachedPlayers);
                setGroupA(Array.isArray(parsed.groupA) && parsed.groupA.length === cachedCount / 2 ? parsed.groupA : fallbackGroups.groupA);
                setGroupB(Array.isArray(parsed.groupB) && parsed.groupB.length === cachedCount / 2 ? parsed.groupB : fallbackGroups.groupB);
                if (Array.isArray(parsed.groupMatches)) setGroupMatches(parsed.groupMatches);
                if (Array.isArray(parsed.bracketMatches)) setBracketMatches(parsed.bracketMatches);
                if (['schedule', 'groups', 'bracket', 'stats'].includes(parsed.tab)) setTab(parsed.tab);
            } catch (error) {
                console.warn('Turnauksen välimuistin lataus epäonnistui.', error);
            }
        }, []);

        useEffect(() => {
            try {
                const snapshot = {
                    view,
                    tab,
                    playerCount,
                    players,
                    groupA,
                    groupB,
                    groupMatches,
                    bracketMatches,
                };
                localStorage.setItem(TOURNAMENT_CACHE_KEY, JSON.stringify(snapshot));
            } catch (error) {
                console.warn('Turnauksen välimuistiin tallennus epäonnistui.', error);
            }
        }, [view, tab, playerCount, players, groupA, groupB, groupMatches, bracketMatches]);

        const updatePlayerCount = (nextCount) => {
            const count = clampEvenPlayerCount(nextCount);
            const nextPlayers = createPlayerNames(count).map((name, idx) => players[idx] ?? name);
            const nextGroups = createBalancedGroups(count);
            setPlayerCount(count);
            setPlayers(nextPlayers);
            setGroupA(nextGroups.groupA);
            setGroupB(nextGroups.groupB);
            setGroupMatches([]);
            setBracketMatches([]);
            setActiveMatch(null);
            setView('setup');
            setTab('schedule');
        };

        const shuffleGroups = () => {
            const shuffledIndices = [...Array(playerCount).keys()].sort(() => Math.random() - 0.5);
            if (hasGroups) {
                const midpoint = playerCount / 2;
                setGroupA(shuffledIndices.slice(0, midpoint));
                setGroupB(shuffledIndices.slice(midpoint));
            } else {
                const shuffledPlayers = shuffledIndices.map((idx) => players[idx]);
                setPlayers(shuffledPlayers);
            }
            confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 } });
        };

        const startTournament = () => {
            const seededPlayers = [...Array(playerCount).keys()].sort(() => Math.random() - 0.5);

            if (hasGroups) {
                setGroupMatches(createBalancedSchedule(groupA, groupB));
                setBracketMatches(createInitialBracketMatches(playerCount, seededPlayers));
            } else {
                setGroupMatches([]);
                setBracketMatches(createInitialBracketMatches(playerCount, seededPlayers));
            }

            setView('tournament');
            setTab('schedule');
        };

        const startNewTournament = () => {
            const defaultGroups = createBalancedGroups(defaultPlayerCount);
            setView('setup');
            setTab('schedule');
            setPlayerCount(defaultPlayerCount);
            setPlayers(createPlayerNames(defaultPlayerCount));
            setGroupA(defaultGroups.groupA);
            setGroupB(defaultGroups.groupB);
            setGroupMatches([]);
            setBracketMatches([]);
            setActiveMatch(null);
            localStorage.removeItem(TOURNAMENT_CACHE_KEY);
        };

        useEffect(() => {
            if (!hasGroups || view !== 'tournament') return;
            const standingsA = getStandings(players, groupMatches, groupA, 'A');
            const standingsB = getStandings(players, groupMatches, groupB, 'B');

            setBracketMatches((prev) => {
                const next = [...prev];
                if (next.length < 5) return next;

                if (standingsA[0]?.played > 0) next[2].p1 = standingsA[0].idx;
                if (standingsB[0]?.played > 0) next[3].p1 = standingsB[0].idx;

                if (standingsA[1]?.played > 0 && standingsB[2]?.played > 0) {
                    next[0].p1 = standingsA[1].idx;
                    next[0].p2 = standingsB[2].idx;
                }
                if (standingsB[1]?.played > 0 && standingsA[2]?.played > 0) {
                    next[1].p1 = standingsB[1].idx;
                    next[1].p2 = standingsA[2].idx;
                }
                return next;
            });
        }, [groupMatches, view, players, groupA, groupB, hasGroups]);

        const handleMatchEnd = (id, s1, s2, history) => {
            if (id.startsWith('m-')) {
                setGroupMatches((prev) => prev.map((m) => (m.id === id ? { ...m, s1, s2, played: true, history } : m)));
            } else {
                setBracketMatches((prev) => {
                    const next = [...prev];
                    const idx = next.findIndex((m) => m.id === id);
                    if (idx === -1) return next;

                    const winner = s1 > s2 ? next[idx].p1 : next[idx].p2;
                    next[idx] = { ...next[idx], s1, s2, winner, history, played: true };

                    if (id === 'wc1' && next[3]) next[3].p2 = winner;
                    if (id === 'wc2' && next[2]) next[2].p2 = winner;
                    if (id === 'sf1') {
                        if (playerCount === 4) next[2].p1 = winner;
                        else if (next[4]) next[4].p1 = winner;
                    }
                    if (id === 'sf2') {
                        if (playerCount === 4) next[2].p2 = winner;
                        else if (next[4]) next[4].p2 = winner;
                    }
                    if (id === 'f' && winner !== null) confetti({ particleCount: 200, spread: 70, origin: { y: 0.6 } });
                    return next;
                });
            }
            setActiveMatch(null);
        };

        const bracketRounds = useMemo(() => {
            if (playerCount === 2) {
                return [{ key: 'F', title: 'Finaali', matches: bracketMatches.filter((m) => m.round === 'F'), isFinal: true }];
            }

            if (playerCount === 4) {
                return [
                    { key: 'SF', title: 'Välierät', matches: bracketMatches.filter((m) => m.round === 'SF') },
                    { key: 'F', title: 'Finaali', matches: bracketMatches.filter((m) => m.round === 'F'), isFinal: true },
                ];
            }

            return [
                { key: 'WC', title: 'Wild Cards', matches: bracketMatches.filter((m) => m.round === 'WC') },
                { key: 'SF', title: 'Välierät', matches: bracketMatches.filter((m) => m.round === 'SF') },
                { key: 'F', title: 'Finaali', matches: bracketMatches.filter((m) => m.round === 'F'), isFinal: true },
            ];
        }, [bracketMatches, playerCount]);


        const tournamentWinnerName = useMemo(() => {
            const finalMatch = bracketMatches.find((m) => m.round === 'F');
            if (!finalMatch || !finalMatch.played || finalMatch.winner === null) return null;
            return players[finalMatch.winner] ?? null;
        }, [bracketMatches, players]);

        const playerStats = useMemo(() => {
            const stats = players.map((name, idx) => ({
                name,
                idx,
                matchesPlayed: 0,
                totalScore: 0,
                dartsCount: 0,
                bestCheckout: 0,
                bestTurn: 0,
                score60plus: 0,
                score100plus: 0,
                score140plus: 0,
                checkoutAttempts: 0,
                checkoutHits: 0,
            }));

            [...groupMatches, ...bracketMatches].forEach((m) => {
                if (m.played) {
                    if (m.p1 !== null) {
                        const p1Stats = stats.find((s) => s.idx === m.p1);
                        if (p1Stats) p1Stats.matchesPlayed++;
                    }
                    if (m.p2 !== null) {
                        const p2Stats = stats.find((s) => s.idx === m.p2);
                        if (p2Stats) p2Stats.matchesPlayed++;
                    }
                }

                if (!m.history) return;

                m.history.forEach((turnData) => {
                    const p = stats.find((s) => s.idx === turnData.player);
                    if (!p) return;

                    const turnSum = turnData.darts.reduce((a, b) => a + (b || 0), 0);
                    p.totalScore += turnSum;
                    p.dartsCount += turnData.darts.length;
                    p.bestTurn = Math.max(p.bestTurn, turnSum);

                    if (turnSum >= 140) p.score140plus++;
                    else if (turnSum >= 100) p.score100plus++;
                    else if (turnSum >= 60) p.score60plus++;

                    (turnData.dartEvents || []).forEach((event) => {
                        if (event.wasDoubleAttempt) p.checkoutAttempts++;
                        if (event.wasSuccessfulDoubleOut) p.checkoutHits++;
                    });

                    if (turnData.isCheckout) {
                        p.bestCheckout = Math.max(p.bestCheckout, turnSum);
                    }
                });
            });

            return stats
                .filter((s) => s.dartsCount > 0)
                .map((s) => ({
                    ...s,
                    avg: (s.totalScore / s.dartsCount) * 3,
                    checkoutPct: s.checkoutAttempts > 0 ? (s.checkoutHits / s.checkoutAttempts) * 100 : 0,
                }))
                .sort((a, b) => b.avg - a.avg);
        }, [groupMatches, bracketMatches, players]);

        if (view === 'setup') {
            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-6">
                    <div className="text-center mb-8 logo-frame rounded-3xl px-8 py-6">
                        <div className="flex justify-center mb-4">
                            <BrandLogo />
                        </div>
                        <p className="text-emerald-100/80 font-bold uppercase tracking-widest mt-2">Mökkiturnaus 27-28.2</p>
                    </div>
                    <div className="bg-slate-900/50 p-8 rounded-3xl border border-white/10 w-full max-w-2xl shadow-2xl">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="uppercase font-black text-slate-400">Pelaajat</h3>
                            <button onClick={shuffleGroups} className="text-xs bg-white/10 hover:bg-white/20 px-3 py-1 rounded-full font-bold transition-all">
                                <i className="fas fa-random mr-2"></i>ARVO LOHKOT
                            </button>
                        </div>
                        <div className="mb-5">
                            <label className="text-[10px] font-bold text-yellow-500 uppercase ml-1 block mb-2">Pelaajamäärä (2-8, vain parillinen)</label>
                            <select
                                value={playerCount}
                                onChange={(e) => updatePlayerCount(Number(e.target.value))}
                                className="w-full bg-black/40 border border-white/5 p-3 rounded-xl text-white font-bold focus:border-yellow-500 outline-none"
                            >
                                {[2, 4, 6, 8].map((count) => <option key={count} value={count}>{count}</option>)}
                            </select>
                        </div>

                        {hasGroups ? (
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div className="space-y-2">
                                    <div className="text-[10px] font-bold text-yellow-500 uppercase ml-1">Lohko A</div>
                                    {groupA.map((idx, i) => (
                                        <input
                                            key={i}
                                            className="w-full bg-black/40 border border-white/5 p-3 rounded-xl text-white font-bold focus:border-yellow-500 outline-none"
                                            value={players[idx]}
                                            onChange={(e) => {
                                                const n = [...players];
                                                n[idx] = e.target.value;
                                                setPlayers(n);
                                            }}
                                        />
                                    ))}
                                </div>
                                <div className="space-y-2">
                                    <div className="text-[10px] font-bold text-yellow-500 uppercase ml-1">Lohko B</div>
                                    {groupB.map((idx, i) => (
                                        <input
                                            key={i}
                                            className="w-full bg-black/40 border border-white/5 p-3 rounded-xl text-white font-bold focus:border-yellow-500 outline-none"
                                            value={players[idx]}
                                            onChange={(e) => {
                                                const n = [...players];
                                                n[idx] = e.target.value;
                                                setPlayers(n);
                                            }}
                                        />
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-2 mb-4">
                                {players.map((name, idx) => (
                                    <input
                                        key={idx}
                                        className="w-full bg-black/40 border border-white/5 p-3 rounded-xl text-white font-bold focus:border-yellow-500 outline-none"
                                        value={name}
                                        onChange={(e) => {
                                            const n = [...players];
                                            n[idx] = e.target.value;
                                            setPlayers(n);
                                        }}
                                    />
                                ))}
                            </div>
                        )}

                        <p className="text-xs text-emerald-200/80 mb-5">
                            Formaatti: {playerCount === 2 ? 'suoraan finaali' : playerCount === 4 ? 'välierät + finaali' : `2 lohkoa (${playerCount / 2} pelaajaa/lohko) + pudotuspelit`}.
                        </p>

                        <button onClick={startTournament} className="w-full py-5 bg-yellow-500 hover:bg-yellow-400 text-black font-black uppercase rounded-2xl text-xl shadow-lg transition-all active:scale-95">
                            Aloita Turnaus
                        </button>
                    </div>
                </div>
            );
        }

        return (
            <div className="min-h-screen flex flex-col">
                <header className="bg-emerald-950/90 p-6 border-b border-yellow-200/15 flex justify-between items-center sticky top-0 z-40 backdrop-blur">
                    <div className="flex items-center gap-4">
                        <div className="logo-frame rounded-2xl p-2"><BrandLogo compact /></div>
                        <div>
                            <h2 className="font-black uppercase italic text-2xl leading-none">TEEPEE <span className="text-yellow-300">DARTS</span></h2>
                            <p className="text-[10px] font-bold text-emerald-200/70 uppercase tracking-widest">Turnaushallinta - <span className="text-emerald-50">Mökkiturnaus 27-28.2</span></p>
                        </div>
                    </div>
                    <div className="flex items-center gap-6">
                        <div className="flex gap-4">
                            {[
                                { id: 'schedule', label: 'Pelit' },
                                ...(hasGroups ? [{ id: 'groups', label: 'Lohkot' }] : []),
                                { id: 'bracket', label: 'Kaavio' },
                                { id: 'stats', label: 'Tilastot' },
                            ].map((t) => (
                                <button key={t.id} onClick={() => setTab(t.id)} className={`uppercase font-black text-xs transition-all ${tab === t.id ? 'text-yellow-300 border-b-2 border-yellow-300' : 'text-emerald-200/70 hover:text-emerald-50'}`}>
                                    {t.label}
                                </button>
                            ))}
                        </div>
                        <button
                            onClick={startNewTournament}
                            className="uppercase font-black text-xs px-3 py-2 rounded-xl border border-yellow-300/50 text-yellow-200 hover:bg-yellow-300/10 transition-all"
                        >
                            Aloita uusi turnaus
                        </button>
                    </div>
                </header>

                <main className="p-6 max-w-5xl mx-auto w-full flex-1">
                    {tab === 'schedule' && (
                        <div className="grid md:grid-cols-2 gap-4">
                            {groupMatches.map((m) => (
                                <div key={m.id} onClick={() => setActiveMatch(m)} className="match-card p-5 rounded-2xl flex justify-between items-center cursor-pointer hover:border-yellow-500/30 group">
                                    <div className="flex flex-col">
                                        <span className="text-[10px] text-slate-500 font-bold mb-1 uppercase">Lohko {m.group}</span>
                                        <span className="text-sm font-black uppercase group-hover:text-yellow-500 transition-colors">{players[m.p1]} vs {players[m.p2]}</span>
                                    </div>
                                    <div className="text-2xl font-mono font-black text-yellow-500 bg-black/40 px-4 py-2 rounded-xl">{m.played ? `${m.s1}-${m.s2}` : 'PELAA'}</div>
                                </div>
                            ))}
                            <div className={`col-span-full ${groupMatches.length > 0 ? 'border-t border-white/10 my-4 pt-4' : ''}`}>
                                <h3 className="text-xs font-black uppercase text-slate-500 mb-4">Pudotuspelit</h3>
                                <div className="grid md:grid-cols-2 gap-4">
                                    {bracketMatches.map((m) => (
                                        <div
                                            key={m.id}
                                            onClick={() => m.p1 !== null && m.p2 !== null && setActiveMatch(m)}
                                            className={`match-card p-5 rounded-2xl flex justify-between items-center ${m.p1 !== null && m.p2 !== null ? 'cursor-pointer hover:border-yellow-500/30 group' : 'opacity-40 cursor-not-allowed'}`}
                                        >
                                            <div className="flex flex-col">
                                                <span className="text-[10px] text-yellow-500 font-bold mb-1 uppercase">{m.label}</span>
                                                <span className="text-sm font-black uppercase">{m.p1 !== null ? players[m.p1] : '???'} vs {m.p2 !== null ? players[m.p2] : '???'}</span>
                                            </div>
                                            <div className="text-2xl font-mono font-black text-yellow-500 bg-black/40 px-4 py-2 rounded-xl">{m.played ? `${m.s1}-${m.s2}` : 'PELAA'}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                    {tab === 'groups' && (
                        <div className="grid md:grid-cols-2 gap-8">
                            {[
                                { label: 'A', indices: groupA },
                                { label: 'B', indices: groupB },
                            ].map((g) => (
                                <div key={g.label} className="bg-slate-900/40 rounded-3xl p-6 border border-white/5">
                                    <h3 className="text-xl font-black uppercase text-yellow-500 mb-4 italic">Lohko {g.label}</h3>
                                    <table className="w-full text-left text-xs uppercase font-bold">
                                        <thead className="text-slate-500 border-b border-white/10">
                                        <tr>
                                            <th className="pb-3">Pelaaja</th>
                                            <th className="pb-3 text-center">V</th>
                                            <th className="pb-3 text-center">+/-</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {getStandings(players, groupMatches, g.indices, g.label).map((s, i) => (
                                            <tr key={i} className={`border-t border-white/5 ${i === g.indices.length - 1 ? 'opacity-30' : ''}`}>
                                                <td className="py-4 text-sm font-black">{s.name}</td>
                                                <td className="py-4 text-center text-yellow-500 text-lg">{s.wins}</td>
                                                <td className="py-4 text-center font-mono text-slate-400">{s.legsDiff > 0 ? `+${s.legsDiff}` : s.legsDiff}</td>
                                            </tr>
                                        ))}
                                        </tbody>
                                    </table>
                                </div>
                            ))}
                        </div>
                    )}
                    {tab === 'bracket' && (
                        <div className="bracket-container">
                            {bracketRounds.map((round, roundIdx) => (
                                <div key={round.key} className="bracket-round">
                                    <div className={`text-[10px] font-black uppercase text-center mb-2 ${round.isFinal ? 'text-yellow-500' : 'text-slate-600'}`}>{round.title}</div>
                                    {round.matches.map((m) => (
                                        <div key={m.id} className={roundIdx < bracketRounds.length - 1 || tournamentWinnerName ? 'bracket-connector' : ''}>
                                            <MatchBox m={m} players={players} onClick={() => m.p1 !== null && m.p2 !== null && setActiveMatch(m)} isFinal={Boolean(round.isFinal)} />
                                        </div>
                                    ))}
                                </div>
                            ))}
                            {tournamentWinnerName && (
                                <div className="bracket-round">
                                    <div className="text-[10px] font-black text-yellow-500 uppercase text-center mb-2">Turnausvoittaja</div>
                                    <div className="match-card bracket-champion-card rounded-2xl border-yellow-500/40 bg-yellow-500/10">
                                        <img src={TOURNAMENT_PRIZE_SRC} alt="Turnauspalkinto" className="bracket-champion-prize" />
                                        <div className="text-base md:text-xl font-black uppercase text-white tracking-wide">{tournamentWinnerName}</div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                    {tab === 'stats' && (
                        <div className="bg-slate-900/40 rounded-3xl p-6 border border-white/5 overflow-x-auto">
                            <h3 className="text-2xl font-black uppercase text-yellow-500 mb-6 italic">Turnaustilastot</h3>
                            <table className="w-full text-left text-xs uppercase font-bold">
                                <thead className="text-slate-500 border-b border-white/10">
                                <tr>
                                    <th className="pb-3">Pelaaja</th>
                                    <th className="pb-3 text-center">Pelatut</th>
                                    <th className="pb-3 text-center">Avg (3t)</th>
                                    <th className="pb-3 text-center">Paras vuoro</th>
                                    <th className="pb-3 text-center">Paras checkout</th>
                                    <th className="pb-3 text-center">Checkout %</th>
                                    <th className="pb-3 text-center">D osumat/yritykset</th>
                                    <th className="pb-3 text-center">60+</th>
                                    <th className="pb-3 text-center">100+</th>
                                    <th className="pb-3 text-center">140+</th>
                                </tr>
                                </thead>
                                <tbody>
                                {playerStats.map((s, i) => (
                                    <tr key={i} className="border-t border-white/5">
                                        <td className="py-4 text-sm font-black">{s.name}</td>
                                        <td className="py-4 text-center text-white">{s.matchesPlayed}</td>
                                        <td className="py-4 text-center text-yellow-500 text-lg">{s.avg.toFixed(1)}</td>
                                        <td className="py-4 text-center text-white">{s.bestTurn || '-'}</td>
                                        <td className="py-4 text-center text-white">{s.bestCheckout || '-'}</td>
                                        <td className="py-4 text-center text-white">{s.checkoutAttempts ? `${s.checkoutPct.toFixed(1)}%` : '-'}</td>
                                        <td className="py-4 text-center text-white">{s.checkoutHits}/{s.checkoutAttempts}</td>
                                        <td className="py-4 text-center text-slate-400">{s.score60plus}</td>
                                        <td className="py-4 text-center text-slate-400">{s.score100plus}</td>
                                        <td className="py-4 text-center text-slate-400">{s.score140plus}</td>
                                    </tr>
                                ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </main>

                {activeMatch && <DartsCalculator key={`${activeMatch.id}-${activeMatch.p1}-${activeMatch.p2}`} match={activeMatch} players={players} onClose={() => setActiveMatch(null)} onSave={handleMatchEnd} />}
            </div>
        );
    }

    function MatchBox({ m, players, onClick, isFinal = false }) {
        const hasPlayers = m.p1 !== null && m.p2 !== null;
        return (
            <div onClick={onClick} className={`match-card p-4 rounded-2xl w-full border-2 transition-all ${!hasPlayers ? 'opacity-30 border-transparent' : 'cursor-pointer hover:border-yellow-500 border-white/5'} ${isFinal ? 'bg-yellow-500/10 border-yellow-500/40' : ''}`}>
                <div className="space-y-3">
                    <div className="flex justify-between items-center text-sm font-black uppercase">
                        <span>{m.p1 !== null ? players[m.p1] : '???'}</span>
                        <span className="bg-black/40 px-2 py-1 rounded text-yellow-500 font-mono">{m.s1}</span>
                    </div>
                    <div className="flex justify-between items-center text-sm font-black uppercase">
                        <span>{m.p2 !== null ? players[m.p2] : '???'}</span>
                        <span className="bg-black/40 px-2 py-1 rounded text-yellow-500 font-mono">{m.s2}</span>
                    </div>
                </div>
            </div>
        );
    }

    function DartsCalculator({ match, players, onClose, onSave }) {
        const victoryAudioRef = useRef(null);
        const scoreAnnouncementAudioRef = useRef(null);
        const confettiRainRef = useRef(null);
        const celebrationTimeoutRef = useRef(null);
        const [p1Score, setP1Score] = useState(STARTING_SCORE);
        const [p2Score, setP2Score] = useState(STARTING_SCORE);
        const [legs, setLegs] = useState([match.s1, match.s2]);
        const [bust, setBust] = useState(false);
        const [winnerOfLeg, setWinnerOfLeg] = useState(null);
        const [isFinishingMatch, setIsFinishingMatch] = useState(false);
        const [hasTournamentPrize, setHasTournamentPrize] = useState(false);

        const [starterDraw] = useState(() => {
            const starter = Math.random() < 0.5 ? 0 : 1;
            return {
                starter,
                name: players[starter === 0 ? match.p1 : match.p2],
            };
        });
        const [showStarterCoin, setShowStarterCoin] = useState(true);
        const isStarterDrawComplete = !showStarterCoin;
        const initialStarter = starterDraw.starter;
        const currentLegIndex = legs[0] + legs[1];
        const legStarter = currentLegIndex % 2 === 0 ? initialStarter : 1 - initialStarter;

        const [turn, setTurn] = useState(legStarter);
        const [dartInTurn, setDartInTurn] = useState(0);
        const [currentDarts, setCurrentDarts] = useState([null, null, null]);
        const [currentDartEvents, setCurrentDartEvents] = useState([null, null, null]);
        const [multiplier, setMultiplier] = useState(1);
        const [turnStartScores, setTurnStartScores] = useState({ p1: STARTING_SCORE, p2: STARTING_SCORE });

        const [history, setHistory] = useState(match.history || []);
        const [stepHistory, setStepHistory] = useState([
            {
                p1Score: STARTING_SCORE,
                p2Score: STARTING_SCORE,
                turn: legStarter,
                dartInTurn: 0,
                currentDarts: [null, null, null],
                currentDartEvents: [null, null, null],
                winnerOfLeg: null,
                turnStartScores: { p1: STARTING_SCORE, p2: STARTING_SCORE },
            },
        ]);

        const currentPlayerIdx = turn === 0 ? match.p1 : match.p2;
        const currentScore = turn === 0 ? p1Score : p2Score;
        const showTournamentPrize = hasTournamentPrize && match.id === 'f';

        useEffect(() => {
            const audio = new Audio(VICTORY_MUSIC_SRC);
            audio.preload = 'auto';
            victoryAudioRef.current = audio;

            return () => {
                if (confettiRainRef.current) {
                    clearInterval(confettiRainRef.current);
                    confettiRainRef.current = null;
                }
                if (celebrationTimeoutRef.current) {
                    clearTimeout(celebrationTimeoutRef.current);
                    celebrationTimeoutRef.current = null;
                }
                if (victoryAudioRef.current) {
                    victoryAudioRef.current.pause();
                    victoryAudioRef.current = null;
                }
                if (scoreAnnouncementAudioRef.current) {
                    scoreAnnouncementAudioRef.current.pause();
                    scoreAnnouncementAudioRef.current = null;
                }
            };
        }, []);

        useEffect(() => {
            const prizeImage = new Image();
            prizeImage.onload = () => setHasTournamentPrize(true);
            prizeImage.onerror = () => setHasTournamentPrize(false);
            prizeImage.src = TOURNAMENT_PRIZE_SRC;

            return () => {
                prizeImage.onload = null;
                prizeImage.onerror = null;
            };
        }, []);

        useEffect(() => {
            const timeoutId = window.setTimeout(() => {
                setShowStarterCoin(false);
            }, 3600);

            return () => window.clearTimeout(timeoutId);
        }, []);

        const playVictoryMusic = () => {
            const audio = victoryAudioRef.current;
            if (!audio) return null;

            audio.currentTime = 0;
            audio.play().catch(() => {
                // Musiikkitiedosto saattaa puuttua tai selaimen autoplay-rajoitukset estävät toiston.
            });

            return audio;
        };

        const playScoreAnnouncement = (turnScore) => {
            if (!Number.isInteger(turnScore) || turnScore < 0 || turnScore > 180) return;

            if (scoreAnnouncementAudioRef.current) {
                scoreAnnouncementAudioRef.current.pause();
                scoreAnnouncementAudioRef.current = null;
            }

            const audio = new Audio(`assets/${turnScore}.wav`);
            audio.preload = 'auto';
            audio.play().catch(() => {
                // Pistemäärän kuulutus voi puuttua tai autoplay-rajoitukset estävät toiston.
            });
            scoreAnnouncementAudioRef.current = audio;
        };

        const launchConfettiRain = () => {
            confetti({ particleCount: 220, spread: 85, origin: { y: 0.55 } });
            confettiRainRef.current = setInterval(() => {
                confetti({ particleCount: 18, angle: 65, spread: 55, origin: { x: 0, y: 0.7 } });
                confetti({ particleCount: 18, angle: 115, spread: 55, origin: { x: 1, y: 0.7 } });
            }, 350);
        };

        const finishMatchWithCelebration = (winner, finalLegs, updatedHistory) => {
            if (isFinishingMatch) return;
            setWinnerOfLeg(winner);
            setIsFinishingMatch(true);

            const audio = playVictoryMusic();
            launchConfettiRain();

            let finished = false;
            const complete = () => {
                if (finished) return;
                finished = true;
                if (confettiRainRef.current) {
                    clearInterval(confettiRainRef.current);
                    confettiRainRef.current = null;
                }
                onSave(match.id, finalLegs[0], finalLegs[1], updatedHistory);
            };

            if (audio) {
                audio.onended = complete;
            }

            const fallbackMs = audio && Number.isFinite(audio.duration) && audio.duration > 0
                ? Math.max(3500, Math.min(audio.duration * 1000, 15000))
                : 9000;

            celebrationTimeoutRef.current = setTimeout(complete, fallbackMs);
        };

        const handleForfeit = (forfeitingPlayer) => {
            if (isFinishingMatch) return;

            const winner = forfeitingPlayer === 0 ? 1 : 0;
            const winnerName = players[winner === 0 ? match.p1 : match.p2];
            const forfeitingName = players[forfeitingPlayer === 0 ? match.p1 : match.p2];

            const confirmed = window.confirm(`${forfeitingName} luovuttaa ottelun. Hyväksytäänkö tulokseksi 3-0 (${winnerName})?`);
            if (!confirmed) return;

            const finalLegs = winner === 0 ? [LEGS_TO_WIN, 0] : [0, LEGS_TO_WIN];
            finishMatchWithCelebration(winner, finalLegs, history);
        };

        const pushStep = (snapshot) => {
            setStepHistory((prev) => [...prev, snapshot]);
        };

        const dartsLeft = 3 - dartInTurn;
        const checkoutAdvice = useMemo(() => getCheckoutAdvice(currentScore, dartsLeft), [currentScore, dartsLeft]);
        const [showCheckoutDetails, setShowCheckoutDetails] = useState(false);

        useEffect(() => {
            setShowCheckoutDetails(false);
        }, [currentScore, turn, dartInTurn]);

        const handleDartInput = (rawVal) => {
            if (winnerOfLeg !== null) return;

            const actualVal = rawVal === 25 ? (multiplier === 2 ? 50 : 25) : rawVal * multiplier;
            const isDoubleHit = (rawVal === 25 && multiplier === 2) || (multiplier === 2 && rawVal >= 1 && rawVal <= 20);
            const remaining = currentScore - actualVal;
            const isValidDoubleOut = remaining === 0 && isDoubleHit;
            const isBust = remaining < 0 || remaining === 1 || (remaining === 0 && !isValidDoubleOut);
            const wasDoubleAttempt = canCheckoutInOneDart(currentScore);
            const dartEvent = {
                scoreBefore: currentScore,
                rawVal,
                multiplier,
                actualVal,
                wasDoubleAttempt,
                wasSuccessfulDoubleOut: isValidDoubleOut,
            };

            const snapshot = {
                p1Score,
                p2Score,
                turn,
                dartInTurn,
                currentDarts: [...currentDarts],
                currentDartEvents: [...currentDartEvents],
                winnerOfLeg,
                turnStartScores: { ...turnStartScores },
            };

            if (isBust) {
                setBust(true);
                setTimeout(() => {
                    setBust(false);
                    setP1Score(turnStartScores.p1);
                    setP2Score(turnStartScores.p2);
                    const bustDarts = [...currentDarts];
                    const bustEvents = [...currentDartEvents];
                    bustDarts[dartInTurn] = actualVal;
                    bustEvents[dartInTurn] = dartEvent;
                    setHistory((prev) => [
                        ...prev,
                        {
                            player: currentPlayerIdx,
                            darts: bustDarts.filter((d) => d !== null).map(() => 0),
                            dartEvents: bustEvents.filter((e) => e !== null),
                            isCheckout: false,
                        },
                    ]);
                    setTurn(turn === 0 ? 1 : 0);
                    setDartInTurn(0);
                    setCurrentDarts([null, null, null]);
                    setCurrentDartEvents([null, null, null]);
                    setMultiplier(1);
                    setTurnStartScores({ p1: turnStartScores.p1, p2: turnStartScores.p2 });
                    pushStep(snapshot);
                }, 1000);
                return;
            }

            const newDarts = [...currentDarts];
            const newDartEvents = [...currentDartEvents];
            newDarts[dartInTurn] = actualVal;
            newDartEvents[dartInTurn] = dartEvent;

            if (isValidDoubleOut) {
                if (turn === 0) setP1Score(0);
                else setP2Score(0);
                setCurrentDarts(newDarts);
                setCurrentDartEvents(newDartEvents);
                setWinnerOfLeg(turn);
                pushStep(snapshot);
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                return;
            }

            if (turn === 0) setP1Score(remaining);
            else setP2Score(remaining);
            setCurrentDarts(newDarts);
            setCurrentDartEvents(newDartEvents);
            setMultiplier(1);
            pushStep(snapshot);

            if (dartInTurn === 2) {
                playScoreAnnouncement(newDarts.reduce((sum, dartScore) => sum + (dartScore ?? 0), 0));
                setTimeout(() => {
                    setHistory((prev) => [...prev, { player: currentPlayerIdx, darts: newDarts, dartEvents: newDartEvents, isCheckout: false }]);
                    setTurn(turn === 0 ? 1 : 0);
                    setDartInTurn(0);
                    setCurrentDarts([null, null, null]);
                    setCurrentDartEvents([null, null, null]);
                    setTurnStartScores({
                        p1: turn === 0 ? remaining : p1Score,
                        p2: turn === 1 ? remaining : p2Score,
                    });
                }, 50);
            } else {
                setDartInTurn(dartInTurn + 1);
            }
        };

        const confirmLeg = () => {
            if (isFinishingMatch) return;
            const updatedHistory = [
                ...history,
                {
                    player: currentPlayerIdx,
                    darts: currentDarts.filter((d) => d !== null),
                    dartEvents: currentDartEvents.filter((e) => e !== null),
                    isCheckout: true,
                },
            ];
            const newLegs = [...legs];
            newLegs[winnerOfLeg]++;

            if (newLegs[winnerOfLeg] >= LEGS_TO_WIN) {
                finishMatchWithCelebration(winnerOfLeg, newLegs, updatedHistory);
            } else {
                setLegs(newLegs);
                setHistory(updatedHistory);
                setWinnerOfLeg(null);
                resetLeg(newLegs);
            }
        };

        const handleBack = () => {
            if (stepHistory.length <= 1 || bust) return;
            const last = stepHistory[stepHistory.length - 1];
            if (last.dartInTurn === 2 && history.length > 0 && winnerOfLeg === null) {
                setHistory((prev) => prev.slice(0, -1));
            }

            setP1Score(last.p1Score);
            setP2Score(last.p2Score);
            setTurn(last.turn);
            setDartInTurn(last.dartInTurn);
            setCurrentDarts(last.currentDarts);
            setCurrentDartEvents(last.currentDartEvents || [null, null, null]);
            setWinnerOfLeg(null);
            setTurnStartScores(last.turnStartScores || { p1: STARTING_SCORE, p2: STARTING_SCORE });
            setStepHistory((prev) => prev.slice(0, -1));
        };

        const resetLeg = (newLegs) => {
            const nextStarter = (newLegs[0] + newLegs[1]) % 2 === 0 ? initialStarter : 1 - initialStarter;
            setP1Score(STARTING_SCORE);
            setP2Score(STARTING_SCORE);
            setTurn(nextStarter);
            setDartInTurn(0);
            setCurrentDarts([null, null, null]);
            setCurrentDartEvents([null, null, null]);
            setMultiplier(1);
            setTurnStartScores({ p1: STARTING_SCORE, p2: STARTING_SCORE });
            setStepHistory([
                {
                    p1Score: STARTING_SCORE,
                    p2Score: STARTING_SCORE,
                    turn: nextStarter,
                    dartInTurn: 0,
                    currentDarts: [null, null, null],
                    currentDartEvents: [null, null, null],
                    winnerOfLeg: null,
                    turnStartScores: { p1: STARTING_SCORE, p2: STARTING_SCORE },
                },
            ]);
        };

        return (
            <div className="fixed inset-0 z-50 bg-slate-950 flex flex-col font-sans overflow-y-auto overscroll-contain touch-pan-y" style={{ WebkitOverflowScrolling: 'touch' }}>
                {bust && <div className="absolute inset-0 z-[60] flex items-center justify-center bg-black/60"><div className="bust-overlay text-6xl sm:text-9xl font-black text-red-500 italic">BUST!</div></div>}
                {showStarterCoin && (
                    <div className="absolute inset-0 z-[63] flex flex-col items-center justify-center gap-6 bg-black/70 px-4">
                        <div className="text-yellow-300 text-xl sm:text-3xl font-black uppercase tracking-wide text-center">Aloittajan arvonta käynnissä...</div>
                        <div className="starter-coin">
                            <div className="starter-coin-name">{starterDraw.name}</div>
                        </div>
                    </div>
                )}
                {isFinishingMatch && (
                    <div className="absolute inset-0 z-[65] flex items-center justify-center bg-black/70 overflow-hidden">
                        {showTournamentPrize && (
                            <>
                                <div className="tournament-prize-glow" aria-hidden="true"></div>
                                <img src={TOURNAMENT_PRIZE_SRC} alt="Turnauspalkinto" className="tournament-prize-image" />
                            </>
                        )}
                        <div className="text-center px-4 sm:px-6 relative z-[3]">
                            <div className="relative z-[3] text-yellow-400 text-3xl sm:text-4xl md:text-6xl font-black uppercase mb-4">OTTELUN VOITTAJA!</div>
                            <div className="winner-name-banner text-white text-4xl sm:text-5xl md:text-8xl font-black uppercase tracking-wide break-words">{players[winnerOfLeg === 0 ? match.p1 : match.p2]}</div>
                            <div className="relative z-[3] text-emerald-100 mt-4 uppercase tracking-[0.2em] sm:tracking-[0.35em] text-[10px] sm:text-xs md:text-sm">Mestari lavalla</div>
                        </div>
                    </div>
                )}
                <div className="p-3 sm:p-4 border-b border-white/5 flex justify-between items-center bg-slate-900 shadow-xl gap-2">
                    <button onClick={onClose} className="text-slate-400 font-black uppercase text-[10px] hover:text-white transition-all">Lopeta</button>
                    <div className="text-center font-oswald uppercase font-black italic text-sm sm:text-xl leading-tight min-w-0">
                        <span className="player-header-name">{players[match.p1]}</span> <span className="text-yellow-500 mx-1 sm:mx-3">{legs[0]} - {legs[1]}</span> <span className="player-header-name">{players[match.p2]}</span>
                    </div>
                    <div className="w-6 sm:w-10"></div>
                </div>
                <div className="flex-1 flex flex-col p-3 sm:p-4 gap-3 sm:gap-4 max-w-4xl mx-auto w-full min-h-[100svh]">
                    <div className="grid grid-cols-2 gap-4">
                        <div className={`p-3 sm:p-6 rounded-2xl sm:rounded-3xl border-2 sm:border-4 ${(isStarterDrawComplete && turn === 0) ? 'border-yellow-500 bg-yellow-500/10' : 'border-white/5 opacity-30'}`}><div className="text-4xl sm:text-7xl font-mono font-black text-center">{p1Score}</div></div>
                        <div className={`p-3 sm:p-6 rounded-2xl sm:rounded-3xl border-2 sm:border-4 ${(isStarterDrawComplete && turn === 1) ? 'border-yellow-500 bg-yellow-500/10' : 'border-white/5 opacity-30'}`}><div className="text-4xl sm:text-7xl font-mono font-black text-center">{p2Score}</div></div>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                        <button
                            onClick={() => handleForfeit(0)}
                            disabled={isFinishingMatch}
                            className={`dart-btn h-11 text-xs uppercase tracking-wide ${isFinishingMatch ? 'opacity-40 cursor-not-allowed' : 'text-red-300 border-red-500/30 bg-red-500/10 hover:bg-red-500/20'}`}
                        >
                            {players[match.p1]} luovuttaa
                        </button>
                        <button
                            onClick={() => handleForfeit(1)}
                            disabled={isFinishingMatch}
                            className={`dart-btn h-11 text-xs uppercase tracking-wide ${isFinishingMatch ? 'opacity-40 cursor-not-allowed' : 'text-red-300 border-red-500/30 bg-red-500/10 hover:bg-red-500/20'}`}
                        >
                            {players[match.p2]} luovuttaa
                        </button>
                    </div>
                    <div className="rounded-2xl border border-yellow-500/35 bg-yellow-500/10 px-4 py-3 text-xs uppercase tracking-wide">
                        <div className="flex items-center justify-between gap-3">
                            <div>
                                <div className="font-black text-yellow-400">Checkout-ehdotus ({currentScore})</div>
                                {checkoutAdvice.best ? (
                                    <div className="text-white font-black text-xl tracking-wide mt-1">{checkoutAdvice.best}</div>
                                ) : (
                                    <div className="text-slate-200 font-bold mt-1">{checkoutAdvice.message}</div>
                                )}
                            </div>
                            <button
                                onClick={() => setShowCheckoutDetails((prev) => !prev)}
                                className="h-9 w-9 shrink-0 rounded-full border border-yellow-500/50 bg-black/25 text-yellow-300 hover:bg-black/40 transition-all"
                                aria-label={showCheckoutDetails ? 'Piilota checkout-vaihtoehdot' : 'Näytä lisää checkout-vaihtoehtoja'}
                                title={showCheckoutDetails ? 'Piilota lisävaihtoehdot' : 'Näytä lisävaihtoehdot'}
                            >
                                <i className={`fas ${showCheckoutDetails ? 'fa-chevron-up' : 'fa-chevron-down'}`}></i>
                            </button>
                        </div>
                    </div>

                    {showCheckoutDetails && (
                        <div className="rounded-2xl border border-yellow-500/30 bg-black/30 p-4 text-xs uppercase tracking-wide space-y-2">
                            <div className="text-slate-200">{checkoutAdvice.message}</div>
                            {checkoutAdvice.alternatives.length > 0 && (
                                <div className="text-slate-300">Vaihtoehdot: {checkoutAdvice.alternatives.slice(0, 3).join(' | ')}</div>
                            )}
                            {checkoutAdvice.setup && <div className="text-slate-300">Setup: {checkoutAdvice.setup}</div>}
                            {checkoutAdvice.missPlan.length > 0 && (
                                <div className="text-slate-400">
                                    {checkoutAdvice.missPlan.map((plan, idx) => (
                                        <div key={idx}>{plan.label}: {plan.route}</div>
                                    ))}
                                </div>
                            )}
                            <div className="text-[10px] text-slate-400 normal-case">
                                Double-out: lopetus vain tuplalla tai BULL 50:llä. 25 ei ole checkout.
                            </div>
                        </div>
                    )}
                    <div className="flex-none sm:flex-1 flex flex-col items-center justify-center gap-3 sm:gap-4 bg-white/5 rounded-2xl sm:rounded-3xl border border-white/10 p-2 sm:p-0 min-h-[120px]">
                        {winnerOfLeg !== null ? (
                            <div className="text-center animate-bounce">
                                <div className="text-yellow-500 text-3xl sm:text-4xl font-black mb-4 uppercase">LEG VOITETTU!</div>
                                <button onClick={confirmLeg} disabled={isFinishingMatch} className={`bg-green-600 px-6 sm:px-8 py-3 sm:py-4 rounded-2xl font-black uppercase text-base sm:text-xl ${isFinishingMatch ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                    {isFinishingMatch ? 'Päätetään ottelua...' : 'Jatka peliä'}
                                </button>
                            </div>
                        ) : (
                            <div className="flex gap-2 sm:gap-4">
                                {currentDarts.map((d, i) => (
                                    <div key={i} className={`dart-slot ${dartInTurn === i ? 'active' : ''}`}><span className="text-2xl sm:text-3xl font-black text-white">{d !== null ? d : ''}</span></div>
                                ))}
                            </div>
                        )}
                    </div>
                    <div className="flex flex-col gap-3 mt-auto">
                        <div className="grid grid-cols-4 gap-2">
                            <button onClick={() => setMultiplier(2)} className={`dart-btn multiplier-btn ${multiplier === 2 ? 'active' : ''}`}>Tupla</button>
                            <button onClick={() => setMultiplier(3)} className={`dart-btn multiplier-btn ${multiplier === 3 ? 'active' : ''}`}>Tripla</button>
                            <button onClick={() => handleDartInput(0)} className="dart-btn opacity-50 uppercase text-xs">Ohi</button>
                            <button onClick={handleBack} className="dart-btn text-red-500"><i className="fas fa-undo"></i></button>
                        </div>
                        <div className="grid grid-cols-5 gap-2">
                            {[20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1].map((n) => (
                                <button key={n} onClick={() => handleDartInput(n)} className="dart-btn font-mono">{n}</button>
                            ))}
                        </div>
                        <button onClick={() => handleDartInput(25)} className="dart-btn w-full bg-slate-800 text-yellow-500 border-2 border-yellow-500/40 uppercase font-black">Bullseye</button>
                    </div>
                </div>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>
